#include <LoRa.h>

// LoRa module settings
#define SS_PIN 10
#define RST_PIN 9
#define DI0_PIN 2
#define BAND 915E6

// Define the pin for the relay that controls the street lights
int relayPin = 7;
int ldrPin = A0; // Pin connected to LDR sensor

unsigned long previousMillis = 0;
const long interval = 120000; // Interval for pinging (2 minutes)

void setup() {
  // Initialize Serial for debugging (optional)
  Serial.begin(9600);

  // Initialize LoRa module
  if (!LoRa.begin(BAND)) {
    Serial.println("LoRa initialization failed. Check your connections.");
    while (true);
  }

  // Set LoRa module pins
  LoRa.setPins(SS_PIN, RST_PIN, DI0_PIN);

  // Set the relay pin as an output
  pinMode(relayPin, OUTPUT);

  // Initialize LDR sensor pin
  pinMode(ldrPin, INPUT);
}

void loop() {
  unsigned long currentMillis = millis();

  if (currentMillis - previousMillis >= interval) {
    // Save the current time
    previousMillis = currentMillis;

    // Read LDR sensor data
    int ldrReading = analogRead(ldrPin);
    bool isLightOn = ldrReading > 500; // Adjust threshold as needed

    // Send data via LoRa
    LoRa.beginPacket();
    LoRa.print(isLightOn);
    LoRa.endPacket();

    // Control the street lights
    if(isLightOn) {
      digitalWrite(relayPin, HIGH); // Turn on lights
    } else {
      digitalWrite(relayPin, LOW);  // Turn off lights
    }

    // Optional: Print sensor reading (for debugging)
    Serial.print("LDR Reading: ");
    Serial.println(ldrReading);
  }
}
